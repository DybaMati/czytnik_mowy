<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nas≈Çuchiwanie cyfr v005</title>
<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f8f9fa;
    margin: 0;
}
h2 { margin-top: 0; }
button {
    font-size: 20px;
    padding: 14px 30px;
    margin: 10px 10px 0 0;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}
#toggle { background: #28a745; color: white; }
#unlock { background: #dc3545; color: white; }
table {
    border-collapse: collapse;
    margin-top: 20px;
    width: 100%;
    max-width: 400px;
}
th, td {
    border: 1px solid #ccc;
    padding: 12px;
    font-size: 26px;
    text-align: center;
}
th { background: #e9ecef; }
.new-row { background: #d4edda; transition: background 1s; }
#info {
    font-size: 18px;
    margin: 15px 0;
    color: #333;
}
#version {
    position: fixed;
    bottom: 10px;
    right: 15px;
    font-size: 14px;
    color: #777;
}
</style>
</head>
<body>

<h2>Nas≈Çuchiwanie cyfr po 2</h2>
<button id="toggle">üéô START</button>
<button id="unlock" style="display:none;">‚õî STOP</button>
<p id="info">START ‚Üí m√≥w pary cyfr (np. ‚Äûdwadzie≈õcia cztery trzydzie≈õci siedem‚Äù)</p>

<table id="table">
    <tr><th>#</th><th>Numer</th></tr>
</table>

<div id="version">005 | 2025-12-26</div>

<script>
let counter = 1;
let listening = false;
let lastTranscript = "";

const table = document.getElementById("table");
const toggleBtn = document.getElementById("toggle");
const unlockBtn = document.getElementById("unlock");
const info = document.getElementById("info");

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

if (!SpeechRecognition) {
    info.textContent = "PrzeglƒÖdarka nie wspiera rozpoznawania mowy.";
} else {
    const recognition = new SpeechRecognition();
    recognition.lang = "pl-PL";
    recognition.interimResults = false;

    // NA IOS ZAWSZE continuous = false !!!
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    recognition.continuous = !isIOS; // tylko na Androidzie i desktopie ciƒÖg≈Çe

    toggleBtn.onclick = () => {
        if (!listening) {
            try {
                recognition.start();
                listening = true;
                toggleBtn.style.display = "none";
                unlockBtn.style.display = "inline-block";
                info.textContent = "S≈Çucham‚Ä¶ m√≥w pary cyfr";
            } catch (e) {
                info.textContent = "B≈ÇƒÖd startu: " + e.message;
            }
        }
    };

    unlockBtn.onclick = () => {
        recognition.stop();
        listening = false;
        toggleBtn.style.display = "inline-block";
        unlockBtn.style.display = "none";
        info.textContent = "Zatrzymano.";
    };

    function addDigits(text) {
        const digitsOnly = text.replace(/\D/g, '');
        if (digitsOnly.length < 2) {
            info.textContent = "Za ma≈Ço cyfr ‚Äì m√≥w dalej";
            return;
        }

        const number = digitsOnly.slice(-4);

        const row = table.insertRow();
        row.insertCell().textContent = counter++;
        row.insertCell().textContent = number;
        row.classList.add("new-row");
        setTimeout(() => row.classList.remove("new-row"), 1000);

        info.textContent = "OK: " + number + " ‚Äì s≈Çucham‚Ä¶";

        // BARDZO SZYBKA synteza mowy
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(number.split('').join(' '));
            utterance.lang = "pl-PL";
            utterance.rate = 1.8;     // jeszcze szybciej
            utterance.pitch = 1.05;   // lekko wy≈ºej, brzmi naturalniej
            utterance.volume = 1.0;
            window.speechSynthesis.speak(utterance);
        }
    }

    recognition.onresult = (event) => {
        const text = event.results[0][0].transcript.trim();
        if (text === lastTranscript) return;
        lastTranscript = text;

        console.log("Rozpoznano:", text);
        addDigits(text);
    };

    recognition.onerror = (e) => {
        console.log("B≈ÇƒÖd:", e.error);
        if (e.error !== "no-speech" && e.error !== "aborted") {
            info.textContent = "B≈ÇƒÖd: " + e.error;
        }
    };

    recognition.onend = () => {
        if (listening) {
            // Na iOS restartujemy natychmiast po zako≈Ñczeniu
            setTimeout(() => {
                if (listening) recognition.start();
            }, isIOS ? 100 : 20); // na iOS dajemy 100 ms, ≈ºeby nie by≈Ço za szybko i nie blokowa≈Ço
        }
    };
}
</script>
</body>
</html>55555555555555555555
