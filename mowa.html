<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyfry po 4 – stabilna na iPhone</title>
    <style>
        body { font-family: -apple-system, Arial, sans-serif; text-align: center; margin: 0; padding: 20px; background: #f4f6f9; }
        h1 { font-size: 28px; color: #2c3e50; }
        button { width: 90%; padding: 20px; font-size: 28px; margin: 15px; border-radius: 16px; color: white; }
        #start { background: #27ae60; }
        #stop { background: #e74c3c; }
        #status { font-size: 26px; margin: 30px; font-weight: bold; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #tabela td { font-size: 64px; letter-spacing: 12px; padding: 25px; }
        .info { font-size: 20px; padding: 20px; background: #fff3cd; border-radius: 12px; margin: 30px; }
    </style>
</head>
<body>
    <h1>Grupy po 4 cyfry</h1>
    <button id="start">▶ Rozpocznij</button>
    <button id="stop">■ Zatrzymaj</button>
    <div id="status">Użyj Safari na iPhonie!</div>
    <table id="tabela"><thead><tr><th>Grupy</th></tr></thead><tbody id="rows"></tbody></table>
    <div class="info">
        <strong>Na iPhonie:</strong><br>
        • Tylko Safari (Chrome nie łapie mowy)<br>
        • Grupy pojawiają się od razu<br>
        • Głos może mówić z opóźnieniem lub na końcu (ograniczenie Apple – nie da się lepiej)
    </div>

    <script>
        console.clear();
        console.log('%cSTART APLIKACJI', 'color: #f1c40f; font-size: 20px; background: #2c3e50; padding: 10px;');

        const tbody = document.getElementById('rows');
        const statusEl = document.getElementById('status');

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert('Brak wsparcia – użyj Safari!');
            console.error('NO SpeechRecognition');
        } else {
            console.log('%cSpeechRecognition OK', 'color: green;');
        }

        const recognition = new SpeechRecognition();
        recognition.lang = 'pl-PL';
        recognition.continuous = true;
        recognition.interimResults = true;

        let buffer = '';
        let speakQueue = [];

        const digitToPolish = {'0':'zero','1':'jeden','2':'dwa','3':'trzy','4':'cztery','5':'pięć','6':'sześć','7':'siedem','8':'osiem','9':'dziewięć'};

        function speakNext() {
            if (speakQueue.length === 0) return;
            const group = speakQueue.shift();
            console.log('%cMÓWIĘ:', 'color: #e67e22; font-size: 18px;', group);
            const words = group.split('').map(d => digitToPolish[d]);
            const utter = new SpeechSynthesisUtterance(words.join(' '));
            utter.lang = 'pl-PL';
            utter.rate = 1.8;
            utter.onend = () => setTimeout(speakNext, 500); // kolejne z opóźnieniem
            speechSynthesis.speak(utter);
            setTimeout(speakNext, 1000); // dodatkowe pchnięcie
        }

        function addGroup(group) {
            console.log('%cNOWA GRUPA:', 'color: #3498db; font-size: 18px;', group);
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.textContent = group;
            row.appendChild(cell);
            tbody.appendChild(row);
            row.scrollIntoView({behavior:'smooth'});

            speakQueue.push(group);
            speakNext();

            statusEl.textContent = `Dodano: ${group}`;
        }

        function processBuffer() {
            while (buffer.length >= 4) {
                const group = buffer.substring(0, 4);
                buffer = buffer.substring(4);
                addGroup(group);
            }
        }

        recognition.onresult = (event) => {
            console.log('%cWYNIK ROZPOZNAWANIA', 'color: #9b59b6;');
            let hasFinal = false;
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                console.log('Tekst:', transcript);
                const digits = transcript.replace(/[^0-9]/g, '');
                if (digits && event.results[i].isFinal) {
                    buffer += digits;
                    hasFinal = true;
                    console.log('Bufor:', buffer);
                }
            }
            if (hasFinal) processBuffer();
        };

        recognition.onstart = () => console.log('%cMIKROFON START', 'color: green;');
        recognition.onend = () => {
            console.log('%cMIKROFON END – mówię resztę');
            speakNext(); // na końcu dokończ kolejkę
        };

        document.getElementById('start').onclick = () => {
            console.log('%cKLIK ROZPOCZNIJ', 'color: #f1c40f; font-size: 20px;');
            buffer = '';
            speakQueue = [];
            tbody.innerHTML = '';
            speechSynthesis.speak(new SpeechSynthesisUtterance('')); // odblokowanie dźwięku
            recognition.start();
            statusEl.textContent = 'Mów cyfry!';
        };

        document.getElementById('stop').onclick = () => {
            console.log('%cKLIK ZATRZYMAJ', 'color: red;');
            recognition.stop();
        };
    </script>
</body>
</html>wwww
