<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Cyfry po 4 – idealna na iPhone</title>
    <style>
        body { font-family: -apple-system, Arial, sans-serif; text-align: center; margin: 0; padding: 20px; background: #f4f6f9; touch-action: manipulation; }
        h1 { font-size: 28px; color: #2c3e50; margin: 20px 0; }
        #tabela { width: 100%; max-width: 600px; margin: 30px auto; border-collapse: collapse; background: white; box-shadow: 0 6px 20px rgba(0,0,0,0.15); border-radius: 16px; overflow: hidden; }
        #tabela th { background: #3498db; color: white; padding: 20px; font-size: 26px; }
        #tabela td { padding: 25px; font-size: 64px; font-weight: bold; letter-spacing: 12px; text-align: center; border-bottom: 2px solid #eee; }
        button { width: 90%; max-width: 500px; padding: 20px; font-size: 28px; margin: 15px auto; cursor: pointer; border: none; border-radius: 16px; color: white; font-weight: bold; display: block; }
        #start { background: #27ae60; }
        #stop { background: #e74c3c; }
        #status { font-size: 26px; margin: 30px; font-weight: bold; min-height: 70px; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .info { font-size: 20px; margin: 30px auto; padding: 20px; background: #fff3cd; border-radius: 12px; max-width: 600px; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <h1>Grupy po 4 cyfry</h1>

    <button id="start">▶ Rozpocznij nasłuchiwanie</button>
    <button id="stop">■ Zatrzymaj</button>
    
    <div id="status">Dotknij „Rozpocznij” i mów cyfry</div>
    
    <table id="tabela">
        <thead>
            <tr>
                <th>Grupy cyfr</th>
            </tr>
        </thead>
        <tbody id="rows"></tbody>
    </table>

    <div class="info">
        <strong>Teraz na iPhonie (Safari):</strong><br>
        • Grupy pojawiają się od razu<br>
        • Każda grupa powtarzana na głos prawie natychmiast<br>
        • Brak lawiny po zatrzymaniu
    </div>

    <script>
        const tbody = document.getElementById('rows');
        const statusEl = document.getElementById('status');

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert('Użyj Safari na iPhonie!');
            throw new Error('No SpeechRecognition');
        }

        const recognition = new SpeechRecognition();
        recognition.lang = 'pl-PL';
        recognition.continuous = true;
        recognition.interimResults = true;

        let buffer = '';
        let pendingSpeak = []; // grupy czekające na odczytanie

        const digitToPolish = {
            '0': 'zero', '1': 'jeden', '2': 'dwa', '3': 'trzy', '4': 'cztery',
            '5': 'pięć', '6': 'sześć', '7': 'siedem', '8': 'osiem', '9': 'dziewięć'
        };

        function speakGroup(group) {
            const words = group.split('').map(d => digitToPolish[d]);
            const text = words.join(' ');
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'pl-PL';
            utter.rate = 1.8;
            utter.volume = 1.0;
            speechSynthesis.speak(utter);
        }

        function processPendingSpeak() {
            if (pendingSpeak.length > 0) {
                const group = pendingSpeak.shift();
                speakGroup(group);
                // Planujemy kolejne z małym opóźnieniem
                setTimeout(processPendingSpeak, 600); // co ~0.6s na grupę – płynnie
            }
        }

        function addGroup(group) {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.textContent = group;
            row.appendChild(cell);
            tbody.appendChild(row);
            row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            statusEl.textContent = `Dodano: ${group}`;
            statusEl.style.color = '#27ae60';

            // Dodaj do kolejki odczytu z małym opóźnieniem
            pendingSpeak.push(group);
            if (pendingSpeak.length === 1) {
                setTimeout(processPendingSpeak, 300); // pierwsze z lekkim opóźnieniem
            }
        }

        function processBuffer() {
            while (buffer.length >= 4) {
                const group = buffer.substring(0, 4);
                buffer = buffer.substring(4);
                addGroup(group);
            }
        }

        recognition.onresult = (event) => {
            let hasNewDigits = false;

            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                const digits = transcript.trim().replace(/[^0-9]/g, '');
                if (digits) {
                    if (event.results[i].isFinal) {
                        buffer += digits;
                        hasNewDigits = true;
                    }
                }
            }

            if (hasNewDigits && buffer.length >= 4) {
                processBuffer();
            }
        };

        recognition.onerror = (event) => {
            console.error('Błąd:', event.error);
            statusEl.textContent = 'Błąd: ' + event.error;
            statusEl.style.color = '#d63031';
        };

        recognition.onstart = () => {
            buffer = '';
            pendingSpeak = [];
            tbody.innerHTML = '';
            statusEl.textContent = 'Mów cyfry – działam!';
            statusEl.style.color = '#27ae60';
        };

        recognition.onend = () => {
            processBuffer(); // dodaj ewentualne pozostałe grupy
            processPendingSpeak(); // dokończ odczytywanie
            statusEl.textContent = 'Zatrzymano. Kliknij Rozpocznij ponownie.';
            statusEl.style.color = '#7f8c8d';
        };

        document.getElementById('start').onclick = () => {
            // Odblokowanie dźwięku
            const silent = new SpeechSynthesisUtterance('');
            silent.volume = 0;
            speechSynthesis.speak(silent);

            recognition.start();
        };

        document.getElementById('stop').onclick = () => {
            recognition.stop();
        };
    </script>
</body>
</html>llllllllllllllllllll
