<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Cyfry po 4 – wersja iPhone</title>
    <style>
        body { font-family: -apple-system, Arial, sans-serif; text-align: center; margin: 0; padding: 20px; background: #f4f6f9; touch-action: manipulation; }
        h1 { font-size: 28px; color: #2c3e50; margin: 20px 0; }
        #tabela { width: 100%; max-width: 600px; margin: 30px auto; border-collapse: collapse; background: white; box-shadow: 0 6px 20px rgba(0,0,0,0.15); border-radius: 16px; overflow: hidden; }
        #tabela th { background: #3498db; color: white; padding: 20px; font-size: 26px; }
        #tabela td { padding: 25px; font-size: 64px; font-weight: bold; letter-spacing: 12px; text-align: center; border-bottom: 2px solid #eee; }
        button { width: 90%; max-width: 500px; padding: 20px; font-size: 28px; margin: 15px auto; cursor: pointer; border: none; border-radius: 16px; color: white; font-weight: bold; display: block; }
        #start { background: #27ae60; }
        #stop { background: #e74c3c; }
        #status { font-size: 26px; margin: 30px; font-weight: bold; min-height: 70px; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .info { font-size: 20px; margin: 30px auto; padding: 20px; background: #fff3cd; border-radius: 12px; max-width: 600px; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <h1>Grupy po 4 cyfry</h1>

    <button id="start">▶ Rozpocznij nasłuchiwanie</button>
    <button id="stop">■ Zatrzymaj</button>
    
    <div id="status">Dotknij „Rozpocznij” i mów cyfry</div>
    
    <table id="tabela">
        <thead>
            <tr>
                <th>Grupy cyfr</th>
            </tr>
        </thead>
        <tbody id="rows"></tbody>
    </table>

    <div class="info">
        <strong>Na iPhonie (Safari):</strong><br>
        • Mów cyfry szybko lub powoli – skrypt sam dzieli co 4 cyfry<br>
        • Każda grupa pojawia się od razu + jest powtarzana na głos<br>
        • Nie czekaj na długą pauzę – działa płynnie!
    </div>

    <script>
        const tbody = document.getElementById('rows');
        const statusEl = document.getElementById('status');

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert('Rozpoznawanie mowy nie jest wspierane w tej przeglądarce. Użyj Safari!');
            statusEl.textContent = 'Użyj Safari na iPhonie';
            statusEl.style.color = '#d63031';
            throw new Error('No SpeechRecognition');
        }

        const recognition = new SpeechRecognition();
        recognition.lang = 'pl-PL';
        recognition.continuous = true;
        recognition.interimResults = true;  // KLUCZOWE dla iPhone – bieżące wyniki

        let buffer = ''; // wszystkie zebrane cyfry w sesji

        const digitToPolish = {
            '0': 'zero', '1': 'jeden', '2': 'dwa', '3': 'trzy', '4': 'cztery',
            '5': 'pięć', '6': 'sześć', '7': 'siedem', '8': 'osiem', '9': 'dziewięć'
        };

        function speakGroup(group) {
            const words = group.split('').map(d => digitToPolish[d] || '');
            const text = words.join(' ');
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'pl-PL';
            utter.rate = 1.8;
            utter.volume = 1.0;
            speechSynthesis.speak(utter);
        }

        function processBuffer() {
            while (buffer.length >= 4) {
                const group = buffer.substring(0, 4);
                buffer = buffer.substring(4);

                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.textContent = group;
                row.appendChild(cell);
                tbody.appendChild(row);

                speakGroup(group);

                statusEl.textContent = `Dodano: ${group}`;
                statusEl.style.color = '#27ae60';

                // Lekki scroll do najnowszej grupy
                row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        recognition.onresult = (event) => {
            let tempDigits = '';

            // Przetwarzamy wszystkie wyniki (final i interim)
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                const digits = transcript.trim().replace(/[^0-9]/g, '');
                if (digits) {
                    if (event.results[i].isFinal) {
                        buffer += digits;
                    } else {
                        tempDigits += digits;
                    }
                }
            }

            // Zawsze przetwarzamy bufor (nawet z interim)
            if (buffer.length >= 4) {
                processBuffer();
            }

            // Opcjonalnie: pokaz tymczasowe w statusie
            if (tempDigits && buffer.length < 4) {
                statusEl.textContent = `Słyszę: ...${tempDigits.slice(-4)}`;
            }
        };

        recognition.onerror = (event) => {
            console.error('Błąd:', event.error);
            if (event.error === 'not-allowed') {
                statusEl.textContent = 'Brak dostępu do mikrofonu!';
            } else {
                statusEl.textContent = 'Błąd: ' + event.error;
            }
            statusEl.style.color = '#d63031';
        };

        recognition.onstart = () => {
            buffer = '';
            tbody.innerHTML = '';
            statusEl.textContent = 'Mów cyfry – działam!';
            statusEl.style.color = '#27ae60';
        };

        recognition.onend = () => {
            processBuffer(); // na koniec sesji dodaj resztę (jeśli >=4)
            statusEl.textContent = 'Zatrzymano. Kliknij Rozpocznij ponownie.';
            statusEl.style.color = '#7f8c8d';
        };

        document.getElementById('start').onclick = () => {
            // Odblokowanie dźwięku na iOS
            const silent = new SpeechSynthesisUtterance('');
            silent.volume = 0;
            speechSynthesis.speak(silent);

            recognition.start();
        };

        document.getElementById('stop').onclick = () => {
            recognition.stop();
        };
    </script>
</body>
</html>gggggggggggggggggggggggggggggggggggggg
